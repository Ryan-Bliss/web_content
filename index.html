<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Wix AI Chat - Iframe Version</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Ensure iframe scales properly */
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1></h1>
        
        <!-- Vertical layout container (chat on top, table below) -->
        <div class="main-content">
            <!-- Collection Table -->
            <div class="table-container">
                <div class="table-header-controls">
                    <h2>AWG Player Stats</h2>
                    <button id="clearAllFiltersBtn" class="clear-all-filters-btn" title="Clear all filters">
                        Clear All Filters
                    </button>
                </div>
                <div class="table-loading" id="tableLoading">
                    <div class="loading-spinner"></div>
                    <p>Loading table data...</p>
                </div>
                <div class="table-wrapper" id="tableWrapper" style="display: none;">
                    <table id="collectionTable">
                        <thead>
                            <tr>
                                <!-- Headers will be generated dynamically from CSV or Wix data -->
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <!-- Data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Chat Window -->
            <div class="chat-container">
                <div class="chat-header">
                    <h2>AI Analyst Chat</h2>
                    <p>Ask any questions about the AWG player stats table below</p>
                </div>
                <div class="chat-messages" id="chatMessages">
                    <div class="message bot-message">
                        <div class="message-content">
                            Hello! I can help answer questions about player stats, trends, or insights for the table below. What would you like to know?
                        </div>
                    </div>
                </div>
                <div class="chat-input-container">
                    <input 
                        type="text" 
                        id="chatInput" 
                        placeholder="Type your question here..." 
                        autocomplete="off"
                    />
                    <button id="sendButton">Send</button>
                </div>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        // ============================================================
        // IFRAME COMMUNICATION - Override data loading for Wix
        // ============================================================
        
        // Store original loadCSVData function
        const originalLoadCSVData = window.loadCSVData;
        
        // Override to support both CSV (local) and Wix data (iframe)
        window.loadCSVData = async function() {
            // Check if we're in an iframe (Wix environment)
            if (window.parent !== window) {
                // Request data from Wix parent
                window.parent.postMessage({ type: 'requestCollectionData' }, '*');
                // Return empty array - data will come via message event
                return [];
            } else {
                // Local testing - use original CSV loading
                return originalLoadCSVData ? await originalLoadCSVData() : [];
            }
        };
        
        // Listen for collection data from Wix parent
        window.addEventListener('message', (event) => {
            // Security: Verify origin in production
            // if (event.origin !== 'https://your-wix-site.com') return;
            
            if (event.data.type === 'collectionData') {
                // Convert Wix collection data to our format
                const wixData = event.data.data || [];
                
                if (wixData.length > 0) {
                    // Set headers from first item if not already set
                    if (csvHeaders.length === 0 && wixData[0]) {
                        csvHeaders = Object.keys(wixData[0]).filter(key => key !== '_id');
                        csvHeaders.unshift('_id'); // Add _id at the beginning
                    }
                    
                    // Convert to our data format
                    mockCollectionData = wixData.map((item, index) => {
                        const row = { ...item };
                        if (!row._id) row._id = item._id || (index + 1).toString();
                        return row;
                    });
                    
                    originalData = [...mockCollectionData];
                    filteredData = [...mockCollectionData];
                    
                    // Hide loading, show table
                    const tableLoading = document.getElementById('tableLoading');
                    const tableWrapper = document.getElementById('tableWrapper');
                    if (tableLoading) tableLoading.classList.add('hidden');
                    if (tableWrapper) tableWrapper.style.display = 'block';
                    
                    // Generate headers and load data
                    generateTableHeaders();
                    applyStickyHeaderStyles();
                    setupTableFilters();
                    setupClearAllFiltersButton();
                    loadTableData();
                }
            } else if (event.data.type === 'chatResponse') {
                // Handle chat response from Wix backend
                handleChatResponse(event.data);
            }
        });
        
        // Override callChatGPTAPI to send to Wix parent instead
        const originalCallChatGPTAPI = window.callChatGPTAPI;
        window.callChatGPTAPI = async function(userMessage) {
            // If in iframe, send to Wix parent
            if (window.parent !== window) {
                // Send message to Wix parent - it will handle API call
                window.parent.postMessage({
                    type: 'chatMessage',
                    message: userMessage,
                    collectionData: filteredData // Send current filtered data
                }, '*');
                
                // Return a promise that resolves when we get the response
                return new Promise((resolve) => {
                    // Store resolve function to call when response arrives
                    window._pendingChatResolve = resolve;
                });
            } else {
                // Local testing - use original function
                return originalCallChatGPTAPI ? await originalCallChatGPTAPI(userMessage) : 'Local test mode';
            }
        };
        
        // Handle chat responses from Wix
        function handleChatResponse(data) {
            // Remove any loading messages
            const loadingMessages = document.querySelectorAll('.message.bot-message .loading');
            loadingMessages.forEach(msg => {
                const messageDiv = msg.closest('.message');
                if (messageDiv) {
                    messageDiv.remove();
                }
            });
            
            // Resolve pending chat promise if exists
            if (window._pendingChatResolve) {
                if (data.success) {
                    window._pendingChatResolve(data.response);
                } else {
                    window._pendingChatResolve(`Sorry, I encountered an error: ${data.error || 'Unknown error'}`);
                }
                window._pendingChatResolve = null;
            } else {
                // Fallback: add message directly
                if (data.success) {
                    addMessage(data.response, 'bot');
                } else {
                    addMessage(`Sorry, I encountered an error: ${data.error || 'Unknown error'}`, 'bot');
                }
            }
        }
        
        // Request data on load if in iframe
        window.addEventListener('load', () => {
            if (window.parent !== window) {
                // We're in an iframe - request data from parent
                window.parent.postMessage({ type: 'requestCollectionData' }, '*');
            }
        });
    </script>
</body>
</html>
